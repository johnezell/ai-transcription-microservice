version: '3.8'

services:
  # We don't need local mysql or phpmyadmin if using AWS Aurora
  # To fully disable them if they are in your main docker-compose.yml without errors,
  # you might need to use Docker Compose profiles, or ensure their definitions
  # in the main docker-compose.yml are minimal if not used (e.g., no port mappings if unused).
  # For now, this override file focuses on reconfiguring Laravel and stubbing out Python services.

  mysql:
    # Overriding to do nothing or use a different port if you still want a local one for other projects
    image: alpine/git # Minimal image to effectively disable it, or just don't bring it up
    command: ["echo", "Local MySQL disabled in override, using AWS Aurora"]
    ports: [] # Clear any port mappings from the base docker-compose.yml
    volumes: [] # Clear any volume mappings
    networks: [] # Ensuring it doesn't try to connect to app-network if not needed

  phpmyadmin:
    image: alpine/git # Minimal image
    command: ["echo", "Local phpMyAdmin disabled in override"]
    ports: []
    networks: [] # Ensuring it doesn't try to connect to app-network if not needed

  laravel:
    # Build context and Dockerfile are inherited from docker-compose.yml
    env_file:
      - ./app/laravel/.env.docker-aws # Uses the .env file generated by setup_local_env.sh
    ports:
      - "${APP_PORT:-8080}:80" # Maps host port 8080 to container's Nginx (running inside) on port 80
    volumes:
      - ./app/laravel:/var/www   # For live code changes
      # Ensure this AWS credentials mount point is correct for the user inside your laravel container (e.g., sail, www-data, root)
      # Common for 'sail' user in Laravel Sail. Adjust if your container user/home dir is different.
      - ~/.aws:/mnt/aws_creds_mounted:ro # For AWS SDK credentials, ensure path is correct for SDK user in container
    # No depends_on: mysql, as DB is external AWS Aurora.
    # No depends_on: nginx, as Nginx runs inside this container via supervisord.
    # Networks are inherited from the main docker-compose.yml (should be app-network)

  # The Nginx service defined in the main docker-compose.yml is not needed when running
  # this local override, because Dockerfile.laravel itself sets up and runs Nginx via supervisord.
  # We can effectively disable it here by overriding it with a minimal image and command.
  nginx:
    image: alpine/git
    command: ["echo", "Standalone Nginx service disabled in override; Laravel container serves its own Nginx"]
    ports: []
    volumes: []
    networks: []

  # --- Disable other Python services for this local Laravel dev setup ---
  audio-extraction-service:
    image: alpine/git # Minimal image to effectively disable it
    command: ["echo", "Audio extraction service disabled"]
    ports: [] # Clear ports
    volumes: [] # Clear volumes
    networks: []

  transcription-service:
    image: alpine/git
    command: ["echo", "Transcription service disabled"]
    ports: []
    volumes: []
    networks: []

  # Use the name for your terminology service as defined in your main docker-compose.yml
  # Example: music-term-recognition-service or terminology-service
  music-term-recognition-service: # Adjust this key if you renamed the service in docker-compose.yml
    image: alpine/git
    command: ["echo", "Terminology service disabled"]
    ports: []
    volumes: []
    networks: []

# If you definitively renamed to terminology-service in the main yml:
# terminology-service:
#   image: alpine/git
#   command: ["echo", "Terminology service disabled"]
#   ports: []
#   volumes: []
#   networks: []

networks:
  app-network:
    # If your main docker-compose.yml defines it as external, you might need to ensure it exists
    # or define it here as well if this override is run standalone.
    # For typical overrides, network definitions are inherited if not specified.
    driver: bridge # Usually inherited, but defining explicitly for clarity is fine.

volumes:
  mysql_data: # This volume is for the local MySQL service, which is now disabled in this override.
              # No need to define it as external unless your base YML expects it and you want to avoid warnings.
    # To prevent docker from complaining if it's defined as external in base and not here:
    # external: true # Or remove this volume if mysql service is fully disabled in override 